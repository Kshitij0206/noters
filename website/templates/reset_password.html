{% extends "base.html" %}
{% block title %}Reset Password{% endblock %}

{% block content %}
<h3 class="mb-3">Reset Your Password</h3>

<form method="POST">
  <!-- OTP -->
  <div class="form-group">
    <label for="otp">OTP</label>
    <input
      type="text"
      id="otp"
      name="otp"
      class="form-control"
      required
    >
  </div>
  <!-- Resend OTP Section -->
<div class="mt-3">
  <button id="resendOtpBtn" class="btn btn-link p-0" disabled>
    Resend OTP in <span id="otpTimer">30</span>s
  </button>
</div>

<script>
let countdown = 30;
const resendBtn = document.getElementById("resendOtpBtn");
const otpTimer = document.getElementById("otpTimer");

function startOtpCountdown() {
  resendBtn.disabled = true;
  otpTimer.textContent = countdown;
  
  const timer = setInterval(() => {
    countdown--;
    otpTimer.textContent = countdown;
    
    if (countdown <= 0) {
      clearInterval(timer);
      resendBtn.textContent = "Resend OTP";
      resendBtn.disabled = false;
    }
  }, 1000);
}

resendBtn.addEventListener("click", () => {
  if (resendBtn.disabled) return;

  resendBtn.textContent = "Sending...";
  resendBtn.disabled = true;

  fetch("/resend-otp", { 
  method: "POST",
  credentials: "include" // âœ… Send session cookies
})

    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("OTP resent successfully!");
        countdown = 30;
        resendBtn.innerHTML = `Resend OTP in <span id="otpTimer">30</span>s`;
        otpTimer.textContent = countdown;
        startOtpCountdown();
      } else {
        alert(data.message || "Error resending OTP");
        resendBtn.textContent = "Resend OTP";
        resendBtn.disabled = false;
      }
    })
    .catch(() => {
      alert("Network error. Please try again.");
      resendBtn.textContent = "Resend OTP";
      resendBtn.disabled = false;
    });
});

startOtpCountdown();
</script>


  <!-- New Password -->
  <div class="form-group">
    <label for="password1">New Password</label>
    <input
      type="password"
      id="password1"
      name="password1"
      class="form-control"
      required
    >
  </div>

  <!-- Confirm Password -->
  <div class="form-group">
    <label for="password2">Confirm New Password</label>
    <input
      type="password"
      id="password2"
      name="password2"
      class="form-control"
      required
    >
  </div>

  <!-- Submit -->
  <button type="submit" class="btn btn-success">Reset Password</button>
</form>
{% endblock %}
