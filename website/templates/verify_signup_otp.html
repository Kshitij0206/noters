{% extends "base.html" %}
{% block title %}Verify Signup OTP{% endblock %}

{% block content %}
<style>
  .otp-container {
    text-align: center;
    margin-top: 50px;
  }
  .verified-message {
    display: none;
    font-size: 22px;
    color: #4caf50;
    font-weight: bold;
    animation: fadeSlide 1s ease forwards;
  }
  @keyframes fadeSlide {
    0% { opacity: 0; transform: translateY(-20px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  .tick {
    font-size: 40px;
    display: inline-block;
    transform: scale(0);
    animation: tickScale 0.5s ease forwards;
  }
  @keyframes tickScale {
    to { transform: scale(1); }
  }
</style>

<div class="otp-container">
  <h2>Verify Signup OTP</h2>
  <p>We have sent an OTP to <strong>{{ email }}</strong></p>

  <form id="otpForm" method="POST">
    <input type="text" name="otp" placeholder="Enter OTP" required style="padding: 8px;">
    <button type="submit" style="padding: 8px 15px;">Verify</button>
  </form>

  <div id="verifiedMsg" class="verified-message">
    <span class="tick">âœ…</span> OTP Verified
  </div>
</div>

<script>
  document.getElementById("otpForm").addEventListener("submit", function(e) {
    e.preventDefault();

    console.log("ðŸ” Submitting OTP form...");

    fetch(window.location.pathname, {
      method: "POST",
      body: new FormData(this),
      headers: {
        "X-Requested-With": "XMLHttpRequest" // Tell Flask it's AJAX
      }
    })
    .then(async res => {
      console.log("ðŸ“© Raw Response Status:", res.status, res.statusText);

      let text = await res.text();
      console.log("ðŸ“œ Raw Response Text:", text);

      try {
        let data = JSON.parse(text);
        console.log("âœ… Parsed JSON:", data);

        if (data.status === "success") {
          console.log("ðŸŽ‰ OTP verified successfully!");
          document.getElementById("otpForm").style.display = "none";
          let msg = document.getElementById("verifiedMsg");
          msg.style.display = "block";
          setTimeout(() => {
  window.location.href = "{{ url_for('views.home') }}";
}, 2000);

        } else {
          console.error("âŒ OTP verification failed:", data.message || "Unknown error");
          alert(data.message || "Invalid OTP, please try again.");
        }
      } catch (err) {
        console.error("ðŸš¨ JSON Parse Error:", err);
        alert("Server returned invalid data. Check console for details.");
      }
    })
    .catch(err => {
      console.error("ðŸ’¥ Fetch Error:", err);
      alert("Error verifying OTP. Check console for details.");
    });
  });
  
</script>

{% endblock %}
