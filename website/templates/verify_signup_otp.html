{% extends "base.html" %}
{% block title %}Verify Signup OTP{% endblock %}

{% block content %}
<style>
  .otp-container {
    text-align: center;
    margin-top: 50px;
  }
  .verified-message {
    display: none;
    font-size: 22px;
    color: #4caf50;
    font-weight: bold;
    animation: fadeSlide 1s ease forwards;
  }
  @keyframes fadeSlide {
    0% { opacity: 0; transform: translateY(-20px); }
    100% { opacity: 1; transform: translateY(0); }
  }
  .tick {
    font-size: 40px;
    display: inline-block;
    transform: scale(0);
    animation: tickScale 0.5s ease forwards;
  }
  @keyframes tickScale {
    to { transform: scale(1); }
  }
</style>

<div class="otp-container">
  <h2>Verify Signup OTP</h2>
  <p>We have sent an OTP to <strong>{{ email }}</strong></p>

  <form id="otpForm" method="POST">
    <input type="text" name="otp" placeholder="Enter OTP" required style="padding: 8px;">
    <button type="submit" style="padding: 8px 15px;">Verify</button>
  </form>

  <!-- Resend OTP Section -->
  <div class="mt-3">
    <button id="resendOtpBtn" class="btn btn-link p-0" disabled>
      Resend OTP in <span id="otpTimer">30</span>s
    </button>
  </div>

  <div id="verifiedMsg" class="verified-message">
    <span class="tick">✅</span> OTP Verified
  </div>
</div>

<script>
  // ---------------- OTP Verification ----------------
  document.getElementById("otpForm").addEventListener("submit", function(e) {
    e.preventDefault();

    fetch(window.location.pathname, {
      method: "POST",
      body: new FormData(this),
      headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(async res => {
      let text = await res.text();
      try {
        let data = JSON.parse(text);
        if (data.status === "success") {
          document.getElementById("otpForm").style.display = "none";
          let msg = document.getElementById("verifiedMsg");
          msg.style.display = "block";
          setTimeout(() => {
            window.location.href = "{{ url_for('views.home') }}";
          }, 2000);
        } else {
          alert(data.message || "Invalid OTP, please try again.");
        }
      } catch (err) {
        alert("Server returned invalid data.");
      }
    })
    .catch(() => {
      alert("Error verifying OTP.");
    });
  });

  // ---------------- Resend OTP Countdown ----------------
  let countdown = 30;
  const resendBtn = document.getElementById("resendOtpBtn");
  const otpTimer = document.getElementById("otpTimer");

  function startOtpCountdown() {
    resendBtn.disabled = true;
    otpTimer.textContent = countdown;

    const timer = setInterval(() => {
      countdown--;
      otpTimer.textContent = countdown;

      if (countdown <= 0) {
        clearInterval(timer);
        resendBtn.textContent = "Resend OTP";
        resendBtn.disabled = false;
      }
    }, 1000);
  }

  resendBtn.addEventListener("click", () => {
    if (resendBtn.disabled) return;

    resendBtn.textContent = "Sending...";
    resendBtn.disabled = true;

    fetch("/resend-otp", { 
  method: "POST",
  credentials: "include" // ✅ Send session cookies
})

      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("OTP resent successfully!");
          countdown = 30;
          resendBtn.innerHTML = `Resend OTP in <span id="otpTimer">30</span>s`;
          startOtpCountdown();
        } else {
          alert(data.message || "Error resending OTP");
          resendBtn.textContent = "Resend OTP";
          resendBtn.disabled = false;
        }
      })
      .catch(() => {
        alert("Network error. Please try again.");
        resendBtn.textContent = "Resend OTP";
        resendBtn.disabled = false;
      });
  });

  startOtpCountdown();
</script>
{% endblock %}
