{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% set hide_home = true %}

{% block content %}
<h1 class="text-center">Hey, {{ user.first_name }}</h1>

<form method="POST" id="noteForm" class="mt-4">
  <input type="hidden" id="note_id" name="note_id">

  <!-- Title -->
  <div class="form-group mb-3">
    <input type="text" id="note-title" name="title"
           class="form-control note-title-input"
           placeholder="Enter note title here (optional)">
  </div>

  <!-- Tags -->
  <div class="form-group">
    <label for="tags">Tags (comma separated):</label>
    <input type="text" class="form-control" name="tags" id="tags" placeholder="e.g. school, urgent">
  </div>

  <!-- Password -->
  <div class="form-group">
    <label for="note_password">Lock this note with a password (optional):</label>
    <input type="password" class="form-control" id="note_password" name="password" placeholder="Enter password to lock note">
    <small class="form-text text-muted">Leave empty for no lock.</small>
  </div>

  <!-- Pin -->
  <div class="form-group">
    <label><input type="checkbox" name="is_pinned" id="is_pinned"> Pin this note</label>
  </div>

  <!-- Background Color -->
  <div class="form-group">
    <label for="bg-color-picker">Note Background Color:</label>
    <select id="bg-color-picker" class="form-control" style="max-width: 200px;">
      <option value="default">Default (match mode)</option>
      <option value="white">White</option>
      <option value="black">Black</option>
      <option value="#f8f9fa">Light Gray</option>
      <option value="#fff3cd">Yellow</option>
      <option value="#d4edda">Green</option>
      <option value="#f8d7da">Red</option>
      <option value="#d1ecf1">Blue</option>
      <option value="#e1bee7">Purple</option>
      <option value="#ffccbc">Orange</option>
      <option value="#c8e6c9">Mint</option>
      <option value="#f0f4c3">Lime</option>
    </select>
  </div>

  <div class="mb-2 d-flex justify-content-end">
    <!-- Mic button -->
    <button type="button" id="mic-btn" title="Start voice input">
      <img src="{{ url_for('static', filename='mic.png') }}" alt="Mic" style="width:20px;height:20px;">
    </button>

    <!-- Fullscreen toggle button -->
    <button type="button" id="fullscreen-btn" title="Toggle fullscreen">
      <img id="fullscreen-icon"
           src="{{ url_for('static', filename='fullscreen.png') }}"
           alt="Fullscreen" style="width:20px;height:20px;">
    </button>
  </div>

  <!-- Fullscreen container -->
  <div id="editor-full-container">
    <!-- Quill Toolbar -->
    <div id="toolbar" class="mb-2">
      <select class="ql-font">
        <option value="arial" selected>Arial</option>
        <option value="georgia">Georgia</option>
        <option value="impact">Impact</option>
        <option value="comic-sans">Comic Sans</option>
        <option value="times-new-roman">Times New Roman</option>
        <option value="verdana">Verdana</option>
        <option value="courier-new">Courier New</option>
        <option value="tahoma">Tahoma</option>
        <option value="calibri">Calibri</option>
        <option value="lucida-console">Lucida Console</option>
      </select>

      <select class="ql-size">
        <option value="8px">8px</option>
        <option value="9px" selected>9px</option>
        <option value="10px">10px</option>
        <option value="11px">11px</option>
        <option value="12px">12px</option>
        <option value="14px">14px</option>
        <option value="16px">16px</option>
        <option value="18px">18px</option>
        <option value="20px">20px</option>
        <option value="22px">22px</option>
        <option value="24px">24px</option>
        <option value="26px">26px</option>
        <option value="36px">36px</option>
        <option value="48px">48px</option>
        <option value="72px">72px</option>
        <option value="96px">96px</option>
      </select>

      <select class="ql-header">
        <option value="1">H1</option>
        <option value="2">H2</option>
        <option value="3">H3</option>
        <option selected>Normal</option>
      </select>
      <select class="ql-align">
        <option selected></option>
        <option value="center"></option>
        <option value="right"></option>
        <option value="justify"></option>
      </select>
      <button type="button" class="ql-direction" value="rtl"></button>
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-underline"></button>
      <button class="ql-strike"></button>
      <button class="ql-blockquote"></button>
      <button class="ql-code-block"></button>
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <button class="ql-clean"></button>
    </div>

    <!-- Quill Editor -->
    <div id="editor-wrapper" style="border: 1px solid #ccc;">
      <div id="editor-container"></div>
    </div>
  </div>

  <input type="hidden" name="note" id="note">
  <input type="hidden" name="note_bg" id="note_bg">

  <br>
  <div class="text-center">
    <button type="submit" class="btn btn-primary">Save Note</button>
  </div>

  <div id="loading-spinner"></div>
</form>

<!-- Fancy Toast -->
<div id="note-toast">
  <span class="tick">âœ…</span>
  <span class="toast-text">Note added!</span>
</div>
{% endblock %}

{% block javascript %}
<script>
  window.editNote = {{ edit_note_json | safe }};
</script>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
  /* Quill font mapping */
.ql-font-arial { font-family: Arial, sans-serif; }
.ql-font-georgia { font-family: Georgia, serif; }
.ql-font-impact { font-family: Impact, sans-serif; }
.ql-font-comic-sans { font-family: "Comic Sans MS", cursive, sans-serif; }
.ql-font-times-new-roman { font-family: "Times New Roman", serif; }
.ql-font-verdana { font-family: Verdana, sans-serif; }
.ql-font-courier-new { font-family: "Courier New", monospace; }
.ql-font-tahoma { font-family: Tahoma, sans-serif; }
.ql-font-calibri { font-family: Calibri, sans-serif; }
.ql-font-lucida-console { font-family: "Lucida Console", monospace; }

/* Toast styling */
#note-toast {
  position: absolute; /* instead of fixed */
  left: 50%;
  transform: translateX(-50%) scale(0.9);
  background: #222;
  color: white;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 9999;
}
#note-toast.show {
  opacity: 1;
  transform: translateX(-50%) scale(1);
}

#note-toast .tick {
  font-size: 20px;
  font-weight: bold;
  color: #28a745;
  animation: tickPop 0.5s ease forwards;
}
@keyframes tickPop {
  0% { transform: scale(0); opacity: 0; }
  50% { transform: scale(1.3); opacity: 1; }
  100% { transform: scale(1); }
}

/* Dark mode mic + fullscreen */
body.dark-mode #mic-btn, body.dark-mode #fullscreen-btn {
  background: #222 !important;
  border: 1px solid #444 !important;
}
body.dark-mode #mic-btn img, body.dark-mode #fullscreen-btn img {
  filter: brightness(0.9) invert(1) !important;
}
</style>

<script>
/* Quill setup */
const Font = Quill.import('attributors/class/font');
Font.whitelist = ['arial','georgia','impact','comic-sans','times-new-roman','verdana','courier-new','tahoma','calibri','lucida-console'];
Quill.register(Font, true);

const Size = Quill.import('attributors/style/size');
Size.whitelist = ['8px','9px','10px','11px','12px','14px','16px','18px','20px','22px','24px','26px','36px','48px','72px','96px'];
Quill.register(Size, true);

const quill = new Quill('#editor-container', {
  theme: 'snow',
  modules: { toolbar: '#toolbar' }
});

/* Toast function */
function showNoteToast(message) {
  const toast = document.getElementById("note-toast");
  toast.querySelector(".toast-text").textContent = message;

  // Position toast at current scroll top + some margin
  toast.style.top = (window.scrollY + 20) + "px";

  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}


/* Save form */
document.getElementById('noteForm').onsubmit = async e => {
  e.preventDefault();
  const plainText = quill.getText().trim();
  if (!plainText) return alert("Note cannot be empty!");
  document.getElementById('note').value = quill.root.innerHTML;
  document.getElementById('note_bg').value = document.getElementById('bg-color-picker').value;

  try {
    const res = await fetch("/home", { method: "POST", body: new FormData(e.target) });
    if (res.ok) {
      showNoteToast("Note saved!");
      if (!document.getElementById("note_id").value) {
        quill.root.innerHTML = "";
        e.target.reset();
      }
    }
  } catch {
    alert("Network error.");
  }
};

/* Edit mode */
document.addEventListener("DOMContentLoaded", () => {
  if (window.editNote && window.editNote.data) {
    document.getElementById("note_id").value = window.editNote.id;
    document.getElementById("note-title").value = window.editNote.title || "";
    document.getElementById("tags").value = window.editNote.tags || "";
    document.getElementById("is_pinned").checked = window.editNote.is_pinned || false;
    document.getElementById("bg-color-picker").value = window.editNote.bg_color || "default";
    applyEditorBackground(window.editNote.bg_color || "default");
    quill.root.innerHTML = window.editNote.data;
  }
});

/* Background color handling */
function applyEditorBackground(bg) {
  const editor = document.querySelector('#editor-container .ql-editor');
  if (bg === 'default') {
    editor.style.removeProperty('background-color');
    editor.style.removeProperty('color');
  } else {
    const textColor = (bg === 'black') ? 'white' : 'black';
    editor.style.backgroundColor = bg;
    editor.style.color = textColor;
  }
}
</script>
{% endblock %}
