{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}
<h1 align="center">Hey, {{ user.first_name }}</h1>
<h1 align="center">Below are your present Notes</h1>

<ul class="list-group list-group-flush" id="notes">
  {% for note in user.notes %}
    <li class="list-group-item">
      <div class="note-preview" id="note-{{ note.id }}"></div>
      <div class="d-flex justify-content-end mt-2">
        <button class="btn btn-secondary btn-sm edit-note-btn"
          data-id="{{ note.id }}"
          data-text='{{ note.data | safe }}'>
          Edit
        </button>
        <button class="btn btn-danger btn-sm delete-note-btn"
          data-id="{{ note.id }}">
          Delete
        </button>
      </div>
    </li>
  {% endfor %}
</ul>

<form method="POST" id="noteForm" class="mt-4">
  <input type="hidden" id="note_id" name="note_id">
  <div id="editor-container" style="height: 200px;"></div>
  <input type="hidden" name="note" id="note">
  <br>
  <div align="center">
    <button type="submit" class="btn btn-primary">Save Note</button>
  </div>
</form>
{% endblock %}

{% block javascript %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script>
  // Initialize Quill editor
const quill = new Quill('#editor-container', {
  theme: 'snow',
  placeholder: 'Write your note here...',
  modules: {
    toolbar: [
      [{ 'size': ['12px', '14px', '16px', '18px', '24px', '32px', '48px'] }],
      ['bold', 'italic', 'underline'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }],
      ['clean']
    ]
  }
});


  // Save note
  const noteForm = document.getElementById('noteForm');
  noteForm.onsubmit = function () {
    document.getElementById('note').value = JSON.stringify(quill.getContents());

    // Reset form shortly after POST
    setTimeout(() => {
      document.getElementById('note_id').value = '';
      quill.setContents([]);
    }, 100);
  };

  // Edit note
  document.querySelectorAll('.edit-note-btn').forEach(button => {
    button.addEventListener('click', () => {
      const noteId = button.dataset.id;
      const noteJson = button.dataset.text;

      try {
        const noteDelta = JSON.parse(noteJson);
        quill.setContents(noteDelta);
        document.getElementById('note_id').value = noteId;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (e) {
        console.error("Invalid note data for editing:", e);
        alert("Could not load note for editing.");
      }
    });
  });

  // Delete note
  document.querySelectorAll('.delete-note-btn').forEach(button => {
    button.addEventListener('click', () => {
      const noteId = button.dataset.id;

      fetch('/delete-note', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ noteId })
      })
      .then(res => {
        if (res.status === 401) {
          window.location.href = "/login";
          return;
        }
        return res.json();
      })
      .then(data => {
        if (data && data.message === 'Note deleted') {
          // If user was editing this note, reset form
          if (document.getElementById('note_id').value === noteId) {
            document.getElementById('note_id').value = '';
            quill.setContents([]);
          }

          // Remove note from the DOM without reload
          const noteItem = document.getElementById('note-' + noteId)?.closest('li');
          if (noteItem) noteItem.remove();
        } else {
          alert('Error deleting note: ' + (data?.message || 'Unknown error.'));
        }
      })
      .catch(err => console.error('Delete error:', err));
    });
  });

  // Render note previews
  const userNotes = {{ notes_json | tojson }};
  userNotes.forEach(note => {
    try {
      const container = document.getElementById('note-' + note.id);
      const tempQuill = new Quill(document.createElement('div'));
      tempQuill.setContents(JSON.parse(note.data));
      container.innerHTML = tempQuill.root.innerHTML;
    } catch (e) {
      console.error("Failed to render note preview:", e);
    }
  });
</script>
{% endblock %}