{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% set hide_home = true %}

{% block content %}
<h1 align="center">Hey, {{ user.first_name }}</h1>

<!-- {% if edit_note %}
<ul class="list-group list-group-flush" id="notes">
  <li class="list-group-item">
    <div class="note-preview" id="note-{{ edit_note.id }}">{{ edit_note.data | safe }}</div>
  </li>
</ul>
{% endif %} -->

<form method="POST" id="noteForm" class="mt-4">
  <input type="hidden" id="note_id" name="note_id">

  <div class="form-group">
    <label for="tags">Tags (comma separated):</label>
    <input type="text" class="form-control" name="tags" id="tags" placeholder="e.g. school, urgent">
  </div>

  <div class="form-group">
    <label for="note_password">Lock this note with a password (optional):</label>
    <input type="password" class="form-control" id="note_password" name="password" placeholder="Enter password to lock note">
    <small class="form-text text-muted">Leave empty for no lock.</small>
  </div>

  <div class="form-group">
    <label><input type="checkbox" name="is_pinned" id="is_pinned"> Pin this note</label>
  </div>

  <div class="form-group">
    <label for="bg-color-picker">Note Background Color:</label>
    <select id="bg-color-picker" class="form-control" style="max-width: 200px;">
      <option value="white">White</option>
      <option value="#f8f9fa">Light Gray</option>
      <option value="#fff3cd">Yellow</option>
      <option value="#d4edda">Green</option>
      <option value="#f8d7da">Red</option>
      <option value="#d1ecf1">Blue</option>
      <option value="#e1bee7">Purple</option>
      <option value="#ffccbc">Orange</option>
      <option value="#c8e6c9">Mint</option>
      <option value="#f0f4c3">Lime</option>
    </select>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-1">
    <label><strong>Editor</strong></label>
    <div>
      <button type="button" class="btn btn-outline-primary btn-sm mr-2" onclick="startVoice()">üé§ Voice</button>
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleFullscreenEditor()">üî≥ Fullscreen</button>
    </div>
  </div>

  <div id="editor-wrapper" style="resize: both; overflow: auto; border: 1px solid #ccc;">
    <div id="editor-container" style="height: 200px;"></div>
  </div>

  <input type="hidden" name="note" id="note">
  <input type="hidden" name="note_bg" id="note_bg">

  <br>
  <div align="center">
    <button type="submit" class="btn btn-primary">Save Note</button>
  </div>
</form>
{% endblock %}

{% block javascript %}
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
  .note-preview * { font-size: 14px !important; }
  #editor-wrapper:fullscreen {
    width: 100vw;
    height: 100vh;
    padding: 0; margin: 0;
    border: none;
    background: white;
    display: flex;
    flex-direction: column;
  }
  #editor-wrapper:fullscreen #editor-container {
    flex: 1;
    height: 100%;
  }
  #editor-wrapper:fullscreen .ql-toolbar,
  #editor-wrapper:fullscreen .ql-editor {
    background: white !important;
    color: black !important;
  }
</style>

<script>
  const Font = Quill.import('formats/font');
  Font.whitelist = ['serif', 'monospace', 'sans-serif', 'arial', 'times-new-roman', 'courier-new', 'georgia', 'tahoma', 'verdana', 'impact', 'comic-sans'];
  Quill.register(Font, true);

  const Size = Quill.import('attributors/style/size');
  Size.whitelist = ['12px', '14px', '16px', '18px', '24px', '32px', '48px'];
  Quill.register(Size, true);

  const quill = new Quill('#editor-container', {
    theme: 'snow',
    placeholder: 'Write your note here...',
    modules: {
      toolbar: [
        [{ font: Font.whitelist }],
        [{ size: Size.whitelist }],
        ['bold', 'italic', 'underline'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
        ['clean']
      ]
    }
  });

  function startVoice() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("‚ö†Ô∏è Your browser does not support voice recognition.");
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.start();

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      const range = quill.getSelection();
      if (range) {
        quill.clipboard.dangerouslyPasteHTML(range.index, transcript + ' ');
      } else {
        quill.clipboard.dangerouslyPasteHTML(quill.getLength() - 1, transcript + ' ');
      }
    };
  }

  function toggleFullscreenEditor() {
    const wrapper = document.getElementById('editor-wrapper');
    if (!document.fullscreenElement) {
      wrapper.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
    } else {
      document.exitFullscreen();
    }
  }

  document.getElementById('bg-color-picker').addEventListener('change', e => {
    const bg = e.target.value;
    document.querySelector('#editor-container .ql-editor').style.backgroundColor = bg;
    document.querySelector('#editor-container .ql-editor').style.color = (bg === 'black') ? 'white' : 'black';
    document.getElementById('note_bg').value = bg;
  });

  document.getElementById('noteForm').onsubmit = function (e) {
    e.preventDefault();
    document.getElementById('note').value = quill.root.innerHTML;
    document.getElementById('note_bg').value = document.getElementById('bg-color-picker').value;
    this.submit();
    setTimeout(() => {
      window.location.href = window.location.pathname; // üîÅ refresh to clear edit state
    }, 100);
  };

  {% if edit_note %}
    quill.root.innerHTML = `{{ edit_note.data | safe }}`;
    document.getElementById('note_id').value = "{{ edit_note.id }}";
    document.getElementById('tags').value = "{{ edit_note.tags }}";
    document.getElementById('bg-color-picker').value = "{{ edit_note.bg_color }}";
    document.querySelector('#editor-container .ql-editor').style.backgroundColor = "{{ edit_note.bg_color }}";
    document.getElementById('note_bg').value = "{{ edit_note.bg_color }}";
    document.getElementById('is_pinned').checked = {{ 'true' if edit_note.is_pinned else 'false' }};
    document.getElementById('note_password').value = "";
  {% endif %}
</script>
{% endblock %}
