{% extends "base.html" %}
{% block title %}All Saved Notes{% endblock %}
{% set hide_saved_notes = true %}

{% block content %}
<h2 class="text-center mb-4">All Saved Notes</h2>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<div class="form-group mb-3">
  <label for="tagFilter">Filter by Tag:</label>
  <select id="tagFilter" class="form-control" style="max-width: 300px;">
    <option value="all">All</option>
    {% for tag in tags %}
      <option value="{{ tag }}">{{ tag }}</option>
    {% endfor %}
  </select>
  <label for="sortSelect">Sort Notes By:</label>
  <select id="sortSelect" class="form-control" style="max-width: 300px;">
    <option value="pinned_date" {% if selected_sort == 'pinned_date' %}selected{% endif %}>Pinned + Newest</option>
    <option value="date_asc" {% if selected_sort == 'date_asc' %}selected{% endif %}>Oldest First</option>
    <option value="title_asc" {% if selected_sort == 'title_asc' %}selected{% endif %}>Title A-Z</option>
    <option value="title_desc" {% if selected_sort == 'title_desc' %}selected{% endif %}>Title Z-A</option>
  </select>
</div>

<div class="container" id="notes-container">
  <div class="row">
    {% for note in notes %}
      <div class="col-md-6 mb-4 note-card" data-tags="{{ note.tags }}">
        <div class="p-3 shadow-sm rounded position-relative fullscreen-note" id="note-{{ note.id }}" style="background-color: {{ note.bg_color or 'white' }}">
          <div 
            class="note-content mb-2 {% if note.is_locked %}locked-blur{% endif %}" 
            id="note-content-{{ note.id }}"
            data-delta='{{ note.data | tojson | safe }}'>
            {% if note.is_locked %}
              <em>This note is locked. Please unlock to view.</em>
            {% endif %}
          </div>

          <button id="summarize-btn-{{ note.id }}" class="btn btn-sm btn-outline-primary mt-2" onclick="summarizeNote({{ note.id }})">
            Summarize
          </button>
          <div class="d-flex gap-2 mt-1">
            <button class="btn btn-sm btn-outline-secondary" onclick="copyNote({{ note.id }})">ðŸ“‹ Copy Note</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="copySummary({{ note.id }})">ðŸ“‹ Copy Summary</button>
          </div>

          <div id="summary-{{ note.id }}" class="summary-output mt-2 text-muted" style="white-space: pre-wrap;"></div>

          <div class="loader-container" id="loader-{{ note.id }}" style="display: none;">
            <div class="typing-indicator">
              <span></span><span></span><span></span>
            </div>
          </div>

          <button class="exit-fullscreen-btn btn btn-sm btn-danger" style="position:absolute; top:10px; right:10px; display:none; z-index:9999;">â¤´ Exit Fullscreen</button>

          <small class="text-muted">
            Created: {{ note.date|ist }}<br>
            Updated: {{ note.last_updated|ist }}
          </small>

          {% if note.is_pinned %}
            <span style="position: absolute; top: 8px; right: 12px; font-size: 20px;" title="Pinned">ðŸ“Œ</span>
          {% else %}
            <span style="position: absolute; top: 8px; right: 12px; font-size: 20px; opacity: 0.3;" title="Not pinned">ðŸ“Œ</span>
          {% endif %}

          <div class="d-flex justify-content-between mt-2">
            <div>
              {% for tag in note.tags.split(',') if tag %}
                <span class="badge badge-info">{{ tag.strip() }}</span>
              {% endfor %}
            </div>
            <div class="note-actions">
              <a href="{{ url_for('views.home') }}?edit={{ note.id }}" 
                 class="btn btn-secondary btn-sm me-2"
                 {% if note.is_locked %}style="pointer-events:none; opacity:0.5;" title="Cannot edit locked note"{% endif %}>
                <img src="{{ url_for('static', filename='edit.png') }}">
              </a>
              <button class="btn btn-danger btn-sm delete-note-btn" data-id="{{ note.id }}">
                <img src="{{ url_for('static', filename='delete.png') }}">
              </button>
              <a href="{{ url_for('views.download_pdf', note_id=note.id) }}" class="btn btn-outline-dark btn-sm">
                <img src="{{ url_for('static', filename='pdf.png') }}">
              </a>
              <button class="btn btn-outline-secondary btn-sm fullscreen-btn" data-id="{{ note.id }}">
                <img src="{{ url_for('static', filename='fullscreen.png') }}">
              </button>
              <a href="{{ url_for('views.note_history', note_id=note.id) }}" class="btn btn-outline-info btn-sm">
                <img src="{{ url_for('static', filename='history.png') }}">
              </a>
              {% if note.is_locked %}
                <button class="btn btn-warning btn-sm unlock-note-btn" data-id="{{ note.id }}">
                  <img src="{{ url_for('static', filename='unlock.png') }}">
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block javascript %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  window.savedNotes = {{ notes_json | tojson | safe }};
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const savedNotes = window.savedNotes;

  function renderNoteContent(noteId, full = false) {
    const note = savedNotes.find(n => n.id === noteId);
    if (!note) return;
    const contentEl = document.getElementById('note-content-' + noteId);
    if (!contentEl || contentEl.classList.contains('locked-blur')) return;

    if (note.data && note.data.ops) {
      let htmlContent = '';
      note.data.ops.forEach(op => {
        if (typeof op.insert === 'string') htmlContent += op.insert;
      });
      if (!full) {
        const maxLength = 200;
        if (htmlContent.length > maxLength) {
          htmlContent = htmlContent.substring(0, maxLength) + "...";
        }
      }
      contentEl.innerHTML = htmlContent;
    }
  }

  // Initial render (preview)
  savedNotes.forEach(note => renderNoteContent(note.id, false));

  // Fullscreen logic
  // Fullscreen logic
document.querySelectorAll('.fullscreen-btn').forEach(button => {
  button.addEventListener('click', () => {
    const noteId = parseInt(button.dataset.id);
    const noteEl = document.getElementById('note-' + noteId);
    
    // Hide fullscreen button when entering fullscreen
    button.style.display = 'none';

    renderNoteContent(noteId, true); // show full before entering fullscreen
    noteEl.requestFullscreen().catch(err => alert(`Error: ${err.message}`));
  });
});

document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    // Back to preview mode
    savedNotes.forEach(note => renderNoteContent(note.id, false));

    // Show all fullscreen buttons again when exiting fullscreen
    document.querySelectorAll('.fullscreen-btn').forEach(btn => btn.style.display = 'inline-block');

    document.querySelectorAll('.exit-fullscreen-btn').forEach(btn => btn.style.display = 'none');
  } else {
    const fsEl = document.fullscreenElement;
    const btn = fsEl?.querySelector('.exit-fullscreen-btn');
    if (btn) btn.style.display = 'block';
  }
});


  // Exit fullscreen button
  document.querySelectorAll('.exit-fullscreen-btn').forEach(button => {
    button.addEventListener('click', () => document.exitFullscreen());
  });

  // Delete Note Handler
  document.querySelectorAll('.delete-note-btn').forEach(button => {
    button.addEventListener('click', () => {
      const noteId = button.dataset.id;
      fetch('/delete-note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ noteId })
      }).then(res => res.json())
      .then(data => {
        if (data?.message === 'Note deleted') {
          document.getElementById('note-' + noteId)?.closest('.col-md-6')?.remove();
        }
      });
    });
  });

  // Tag Filter
  document.getElementById('tagFilter').addEventListener('change', function () {
    const selectedTag = this.value.toLowerCase();
    document.querySelectorAll('.note-card').forEach(card => {
      const cardTags = card.dataset.tags.toLowerCase();
      card.style.display = (selectedTag === 'all' || cardTags.includes(selectedTag)) ? 'block' : 'none';
    });
  });

  // Sort select
  document.getElementById('sortSelect').addEventListener('change', function () {
    const sortValue = this.value;
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set('sort', sortValue);
    window.location.href = newUrl.toString();
  });
});
</script>

<style>
.fullscreen-note:fullscreen {
  background: white;
  color: black;
  padding: 20px;
  height: 100%;
  width: 100%;
  overflow: auto;
}
.locked-blur {
  filter: blur(6px);
  user-select: none;
  pointer-events: none;
}
.note-actions img {
  width: 16px;
  height: 16px;
}
/* Dark mode overrides for note previews */
body.dark-mode .fullscreen-note {
  background-color: #1e1e1e !important; /* Dark background */
  color: white !important; /* White text */
}

body.dark-mode .fullscreen-note .note-content {
  color: white !important; /* White text */
}

</style>
{% endblock %}
