{% extends "base.html" %}
{% block title %}All Saved Notes{% endblock %}
{% set hide_saved_notes = true %}

{% block content %}
<h2 class="text-center mb-4">All Saved Notes</h2>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Filter & Sort -->
<div class="form-group mb-3">
  <label for="tagFilter">Filter by Tag:</label>
  <select id="tagFilter" class="form-control" style="max-width: 300px;">
    <option value="all">All</option>
    {% for tag in tags %}
      <option value="{{ tag }}">{{ tag }}</option>
    {% endfor %}
  </select>

  <label for="sortSelect" class="mt-2">Sort Notes By:</label>
  <select id="sortSelect" class="form-control" style="max-width: 300px;">
    <option value="pinned_date" {% if selected_sort == 'pinned_date' %}selected{% endif %}>Pinned + Newest</option>
    <option value="date_asc" {% if selected_sort == 'date_asc' %}selected{% endif %}>Oldest First</option>
    <option value="title_asc" {% if selected_sort == 'title_asc' %}selected{% endif %}>Title A-Z</option>
    <option value="title_desc" {% if selected_sort == 'title_desc' %}selected{% endif %}>Title Z-A</option>
  </select>
</div>

<!-- Notes Grid -->
<div class="container" id="notes-container">
  <div class="row">
    {% for note in notes %}
      <div class="col-md-6 mb-4 note-card" data-tags="{{ note.tags | default('') }}">
        <div class="p-3 shadow-sm rounded position-relative fullscreen-note" 
             id="note-{{ note.id }}" 
             style="background-color: {{ note.bg_color or 'white' }}">

          <!-- ✅ Note Title -->
          <h5 class="fw-bold mb-2" style="word-break: break-word;">
            {{ note.title or "(Untitled)" }}
          </h5>

          <!-- Note Content -->
          <div class="note-content mb-2  {% if note.is_locked %}locked-blur{% endif %}"
               id="note-content-{{ note.id }}"
               data-delta='{{ note.content | safe }}'>
            {% if note.is_locked %}
              <em>This note is locked. Please unlock to view.</em>
            {% endif %}
          </div>
          
          <!-- Rest of your card content remains unchanged -->

          <!-- Actions: Summarize & Copy -->
          {% if not note.is_locked %}
  <button id="summarize-btn-{{ note.id }}" 
          class="btn btn-sm btn-outline-primary mt-2" 
          onclick="summarizeNote({{ note.id }})">Summarize</button>
{% else %}
  <button class="btn btn-sm btn-outline-secondary mt-2" disabled title="Unlock note to summarize">
    🔒 Summarize
  </button>
{% endif %}

          <div class="d-flex gap-2 mt-1">
            <button class="btn btn-sm btn-outline-secondary" onclick="copyNote({{ note.id }})"><img src="{{ url_for('static', filename='copy.png') }}" alt="Copy" style="width:16px;height:16px;"></button>
          </div>

          <!-- Summary Output -->
<div id="summary-{{ note.id }}" 
     class="summary-output mt-2 text-muted" 
     style="white-space: pre-wrap;"></div>

<!-- Copy Summary button appears ONLY after summary is generated -->
<div id="copy-summary-container-{{ note.id }}" class="mt-1" style="display: none;">
  <button class="btn btn-sm btn-outline-secondary" 
          onclick="copySummary({{ note.id }})"><img src="{{ url_for('static', filename='copy.png') }}" alt="Copy" style="width:16px;height:16px;"></button>
</div>


          <!-- Loader -->
          <div class="loader-container" id="loader-{{ note.id }}" style="display: none;">
            <div class="typing-indicator"><span></span><span></span><span></span></div>
          </div>

          <!-- Exit Fullscreen -->
          <button class="exit-fullscreen-btn btn btn-sm btn-danger" 
        style="position:absolute; top:10px; right:10px; display:none; z-index:9999; height:30px; width:30px;">
  <img src="{{ url_for('static', filename='m.png') }}" alt="Exit Fullscreen" id="fullscreen-exit-icon">
</button>


          <!-- Dates -->
          <small class="text-muted">
            Created: {{ note.date|ist }}<br>
            Updated: {{ note.last_updated|ist }}
          </small>

          <!-- Pin Icon -->
          {% if note.is_pinned %}
            <span style="position: absolute; top: 8px; right: 12px; font-size: 20px;" title="Pinned">📌</span>
          {% else %}
            <span style="position: absolute; top: 8px; right: 12px; font-size: 20px; opacity: 0.3;" title="Not pinned">📌</span>
          {% endif %}

          <!-- Tags & Note Actions -->
          <div class="d-flex justify-content-between mt-2">
            <div>
              {% for tag in note.tags.split(',') if tag.strip() %}
                <span class="badge bg-info text-dark">{{ tag.strip() }}</span>
              {% endfor %}
            </div>
            <div class="note-actions">
              <a href="{{ url_for('views.edit_note', note_id=note.id) }}"
                 class="btn btn-secondary btn-sm me-2"
                <a href="#" class="edit-note-btn" 
   data-id="{{ note.id }}"
   data-title="{{ note.title }}"
   data-tags="{{ note.tags }}"
   data-content="{{ note.data | tojson | safe }}"
   data-color="{{ note.bg_color }}"
   data-pinned="{{ note.is_pinned }}"
   {% if note.is_locked %}style="pointer-events:none; opacity:0.5;" title="Cannot edit locked note"{% endif %}>
  <img src="{{ url_for('static', filename='edit.png') }}" alt="Edit">
</a>

              <button class="btn btn-danger btn-sm delete-note-btn" data-id="{{ note.id }}">
                <img src="{{ url_for('static', filename='delete.png') }}" alt="Delete">
              </button>
              <a href="{{ url_for('views.download_pdf', note_id=note.id) }}" class="btn btn-outline-dark btn-sm" title="Download PDF">
                <img src="{{ url_for('static', filename='pdf.png') }}" alt="PDF">
              </a>
              <button class="btn btn-outline-secondary btn-sm fullscreen-btn" data-id="{{ note.id }}" title="Fullscreen">
                <img src="{{ url_for('static', filename='fullscreen.png') }}" alt="Fullscreen">
              </button>
              <a href="{{ url_for('views.note_history', note_id=note.id) }}" class="btn btn-outline-info btn-sm" title="History">
                <img src="{{ url_for('static', filename='history.png') }}" alt="History">
              </a>
              {% if note.is_locked %}
                <button class="btn btn-warning btn-sm unlock-note-btn" data-id="{{ note.id }}" title="Unlock">
                  <img src="{{ url_for('static', filename='unlock.png') }}" alt="Unlock">
                </button>
              {% endif %}
            </div>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
  window.savedNotes = {{ notes_json | tojson | safe }};
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const savedNotes = window.savedNotes;

  // Render note content preview or full content
  function renderNoteContent(noteId, full = false) {
    const note = savedNotes.find(n => n.id === noteId);
    if (!note) return;
    const contentEl = document.getElementById('note-content-' + noteId);
    if (!contentEl || contentEl.classList.contains('locked-blur')) return;

    if (note.data && note.data.ops) {
      let htmlContent = '';
      note.data.ops.forEach(op => {
        if (typeof op.insert === 'string') htmlContent += op.insert;
      });
      if (!full && htmlContent.length > 200) {
        htmlContent = htmlContent.substring(0, 200) + "...";
      }
      contentEl.innerHTML = htmlContent;
    }
  }

  // Initial render preview for all notes
  savedNotes.forEach(note => renderNoteContent(note.id, false));

document.querySelectorAll('.fullscreen-btn').forEach(button => {
  button.addEventListener('click', () => {
    const noteId = parseInt(button.dataset.id);
    const noteEl = document.getElementById('note-' + noteId);

    renderNoteContent(noteId, true);

    noteEl.requestFullscreen().then(() => {
      const exitBtn = noteEl.querySelector('.exit-fullscreen-btn');
      if (exitBtn) {
        exitBtn.style.display = 'block';
        const icon = exitBtn.querySelector('img');
        if (icon) {
          // ✅ Always set m.png
          icon.src = "{{ url_for('static', filename='m.png') }}";
        }
      }
    }).catch(err => alert(`Error: ${err.message}`));
  });
});

// ✅ Also set icon when fullscreen changes
document.addEventListener('fullscreenchange', () => {
  if (document.fullscreenElement) {
    const exitBtn = document.fullscreenElement.querySelector('.exit-fullscreen-btn');
    if (exitBtn) {
      const icon = exitBtn.querySelector('img');
      if (icon) {
        icon.src = "{{ url_for('static', filename='m.png') }}"; // ensure m.png is applied
      }
    }
  } else {
    document.querySelectorAll('.exit-fullscreen-btn').forEach(btn => btn.style.display = 'none');
    window.savedNotes.forEach(note => renderNoteContent(note.id, false));
  }
});




  document.querySelectorAll('.exit-fullscreen-btn').forEach(button => {
    button.addEventListener('click', () => document.exitFullscreen());
  });

  // Delete note handler
  document.querySelectorAll('.delete-note-btn').forEach(button => {
    button.addEventListener('click', () => {
      const noteId = button.dataset.id;
      if (!confirm("Are you sure you want to delete this note?")) return;
      fetch('/delete-note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ noteId })
      }).then(res => res.json())
        .then(data => {
          if (data?.message === 'Note deleted') {
            document.getElementById('note-' + noteId)?.closest('.col-md-6')?.remove();
            showActionToast("Note deleted!");
          } else {
            alert("Failed to delete note.");
          }
        }).catch(() => alert("Network error while deleting note."));
    });
  });

  // Tag filter
  document.getElementById('tagFilter').addEventListener('change', function () {
    const selectedTag = this.value.toLowerCase();
    document.querySelectorAll('.note-card').forEach(card => {
      const cardTags = (card.dataset.tags || '').toLowerCase();
      card.style.display = (selectedTag === 'all' || cardTags.includes(selectedTag)) ? 'block' : 'none';
    });
  });

  // Sort select (reload page with sort param)
  document.getElementById('sortSelect').addEventListener('change', function () {
    const sortValue = this.value;
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.set('sort', sortValue);
    window.location.href = newUrl.toString();
  });
});
</script>

<script>
// Copy functions with toast
  function copyToClipboard(title, quill) {
  const contentText = quill.getText();  // Gets plain text only
  const fullText = `${title}\n\n${contentText}`;
  
  navigator.clipboard.writeText(fullText).then(() => {
    alert("Note copied as plain text!");
  }).catch(err => {
    console.error('Failed to copy:', err);
  });
}


  function showCopyToast(message) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.style.position = "fixed";
    toast.style.bottom = "20px";
    toast.style.right = "20px";
    toast.style.background = "#333";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "8px";
    toast.style.zIndex = 9999;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }



function copySummary(noteId) {
  const summaryEl = document.getElementById('summary-' + noteId);
  if (!summaryEl) return;
  const textToCopy = summaryEl.innerText.trim();
  if (!textToCopy) return;
  navigator.clipboard.writeText(textToCopy).then(() => showCopyToast("Summary copied!"));
}

function showCopyToast(message) {
  const old = document.getElementById("copy-toast");
  if (old) old.remove();
  const toast = document.createElement("div");
  toast.id = "copy-toast";
  toast.innerHTML = `<span class="tick">✅</span><span class="toast-text">${message}</span>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 50);
  setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 500); }, 2500);
}

function showActionToast(message) {
  const old = document.getElementById("action-toast");
  if (old) old.remove();
  const toast = document.createElement("div");
  toast.id = "action-toast";
  toast.innerHTML = `<span class="tick">✅</span><span class="toast-text">${message}</span>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 50);
  setTimeout(() => { toast.classList.remove("show"); setTimeout(() => toast.remove(), 500); }, 2500);
}
</script>

<script>
// Summarize Note
function summarizeNote(noteId) {
  const note = window.savedNotes.find(n => n.id === noteId);
  if (!note) return;
  const loader = document.getElementById(`loader-${noteId}`);
  const summaryEl = document.getElementById(`summary-${noteId}`);
  const copyContainer = document.getElementById(`copy-summary-container-${noteId}`);

  loader.style.display = 'block';
  summaryEl.textContent = '';
  copyContainer.style.display = 'none'; // hide before new summary

  let noteText = '';
  if (note.data && note.data.ops) {
    note.data.ops.forEach(op => {
      if (typeof op.insert === 'string') noteText += op.insert;
    });
  }
document.querySelectorAll('.edit-note-btn').forEach(button => {
  button.addEventListener('click', function (e) {
    e.preventDefault();

    // Capture note data from the button
    const noteData = {
      id: this.dataset.id,
      title: this.dataset.title,
      tags: this.dataset.tags,
      bg_color: this.dataset.color,
      is_pinned: this.dataset.pinned === 'True',
      data: JSON.parse(this.dataset.content)
    };

    // Store globally so home.html can access it
    localStorage.setItem('editNote', JSON.stringify(noteData));

    // Redirect back to home to populate the form
    window.location.href = '/home';
  });
});

  fetch('/summarize_note', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ content: noteText })
  }).then(res => res.json())
    .then(data => {
      loader.style.display = 'none';
      if (data.summary) {
        summaryEl.textContent = data.summary;
        copyContainer.style.display = 'block'; // show copy button
      } else {
        summaryEl.textContent = '❌ Error: Could not summarize.';
      }
    }).catch(() => {
      loader.style.display = 'none';
      summaryEl.textContent = '❌ Error connecting to summarizer.';
    });
}

</script>

<style>
  /* === DARK MODE SUPPORT FOR NOTE PREVIEW === */
body.dark-mode .note-card .fullscreen-note {
  border: 1px solid #444;
  color: #eee;
}

body.dark-mode .note-card .fullscreen-note h5 {
  color: #fff;
}

body.dark-mode .note-card .fullscreen-note small.text-muted {
  color: #bbb !important;
}

body.dark-mode .note-card .badge {
  background-color: #444 !important;
  color: #ddd !important;
}

body.dark-mode .note-card .note-actions .btn-outline-dark {
  border-color: #ccc;
  color: #ccc;
}

body.dark-mode .note-card .note-actions img {
  filter: brightness(0.8);
}

body.dark-mode .summary-output {
  color: #ccc;
}

body.dark-mode select,
body.dark-mode .form-control {
  background-color: #1e1e1e;
  color: #eee;
  border-color: #555;
}
  /* Existing styles... */

  /* === DARK MODE NOTE PREVIEW STYLING === */
  body.dark-mode .note-card .fullscreen-note {
    border: 1px solid #444;
    color: #f1f1f1;
  }

  body.dark-mode .note-card .fullscreen-note h5 {
    color: #fff;
  }

  body.dark-mode .note-card .fullscreen-note small.text-muted {
    color: #bbb !important;
  }

  body.dark-mode .note-card .badge {
    background-color: #333 !important;
    color: #eee !important;
  }

  body.dark-mode .note-card .note-actions .btn-outline-dark {
    border-color: #ccc;
    color: #ccc;
  }

  body.dark-mode .note-card .note-actions img {
    filter: brightness(0.8);
  }

  body.dark-mode .summary-output {
    color: #ccc;
  }

  body.dark-mode select,
  body.dark-mode .form-control {
    background-color: #1e1e1e;
    color: #eee;
    border-color: #555;
  }

  /* Optional: override light note backgrounds in dark mode */
  body.dark-mode .note-card .fullscreen-note[style*="background-color"] {
    background-color: rgba(255, 255, 255, 0.05) !important;
  }

.exit-fullscreen-btn img {
  width: 18px;   /* resize icon */
  height: 18px;  /* keep square */
  object-fit: contain; /* prevent distortion */
  display: block; /* remove extra spacing */
  margin: auto;   /* center inside button */
}

  .note-card h5 {
  font-size: 1.1rem;
  font-weight: 600;
  color: #222;
}
body.dark-mode .note-card h5 {
  color: #fff;
}

  /* Fullscreen styling */
  .fullscreen-note:fullscreen {
    background: white;
    color: black;
    padding: 20px;
    height: 100%;
    width: 100%;
    overflow: auto;
  }
  body.dark-mode .fullscreen-note:fullscreen {
    background-color: #1e1e1e !important;
    color: white !important;
  }
  body.dark-mode .fullscreen-note .note-content {
    color: white !important;
  }

  /* Locked blur */
  .locked-blur {
    filter: blur(6px);
    user-select: none;
    pointer-events: none;
  }

  /* Note actions icons */
  .note-actions img {
    width: 16px;
    height: 16px;
  }

  /* Typing indicator loader */
  .typing-indicator {
    display: flex;
    gap: 6px;
    height: 20px;
    justify-content: center;
    align-items: center;
  }
  .typing-indicator span {
    width: 8px;
    height: 8px;
    background: #555;
    border-radius: 50%;
    animation: blink 1.4s infinite ease-in-out both;
  }
  .typing-indicator span:nth-child(1) { animation-delay: 0s; }
  .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
  .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
  body.dark-mode .typing-indicator span {
    background: white !important;
  }
  @keyframes blink {
    0%, 80%, 100% { transform: scale(0); opacity: 0.2; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Toast styling */
  #copy-toast, #action-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) scale(0.9);
    background: #222;
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
  }
  #copy-toast.show, #action-toast.show {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }
  .tick {
    font-size: 18px;
    font-weight: bold;
    color: gray;
    transform: scale(0);
    animation: popTick 0.4s ease forwards, tickColor 0.4s ease forwards 0.4s, moveLeft 0.4s ease forwards 0.7s;
  }
  @keyframes popTick { to { transform: scale(1); } }
  @keyframes tickColor { to { color: #28a745; } }
  @keyframes moveLeft { to { margin-right: 2px; transform: translateX(-6px) scale(1); } }
  .toast-text {
    opacity: 0;
    white-space: nowrap;
    animation: fadeInText 0.4s ease forwards 0.8s;
  }
  @keyframes fadeInText { to { opacity: 1; } }


  /* Animate fullscreen enter/exit */
.fullscreen-note {
  transition: transform 0.3s ease, opacity 0.3s ease;
  will-change: transform, opacity;
}

.fullscreen-note:fullscreen {
  animation: fullscreenEnter 0.3s forwards;
}

@keyframes fullscreenEnter {
  0% {
    opacity: 0;
    transform: scale(0.95);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

:fullscreen:not(.fullscreen-note) {
  animation: fullscreenExit 0.3s forwards;
}

@keyframes fullscreenExit {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0.95);
  }
}

</style>
<script>
  function copyNote(noteId) {
  const note = window.savedNotes.find(n => n.id === noteId);
  if (!note) return;

  const title = note.title || "(Untitled)";
  let html = "";

  // Get the raw HTML from Quill ops
  if (note.data && note.data.ops) {
    note.data.ops.forEach(op => {
      if (typeof op.insert === 'string') html += op.insert;
    });
  }

  // Strip HTML tags if any were present (extra safety)
  const tempDiv = document.createElement("div");
  tempDiv.innerHTML = html;
  const plainText = tempDiv.textContent || tempDiv.innerText || "";

  const fullText = `${title}\n\n${plainText.trim()}`;

  navigator.clipboard.writeText(fullText).then(() => {
    showCopyToast("Note copied!");
  }).catch(err => {
    console.error("Copy failed:", err);
    alert("Failed to copy note.");
  });
}

</script>

{% endblock %}
